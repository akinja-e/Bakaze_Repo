{% doc %}
  Renders predictive search component with autocomplete

  @param {string} class - Additional CSS classes
{% enddoc %}

<div
  x-data="predictiveSearch()"
  x-on:click.outside="close()"
  class="relative {{ class }}"
>
  <!-- Search Toggle Button (Desktop) -->
  <button
    x-on:click="toggle()"
    type="button"
    class="p-2 text-current hover:opacity-70 transition"
    aria-label="Search"
  >
    {% render 'icon-search' %}
  </button>

  <!-- Search Dropdown -->
  <div
    x-show="isOpen"
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0 translate-y-2"
    x-transition:enter-end="opacity-100 translate-y-0"
    x-transition:leave="transition ease-in duration-150"
    x-transition:leave-start="opacity-100 translate-y-0"
    x-transition:leave-end="opacity-0 translate-y-2"
    x-cloak
    class="absolute right-0 top-full mt-2 w-screen max-w-md bg-white rounded-lg shadow-xl border border-gray-200 overflow-hidden z-50"
  >
    <!-- Search Input -->
    <form action="{{ routes.search_url }}" method="get" class="p-4 border-b border-gray-100">
      <div class="relative">
        <input
          x-ref="searchInput"
          x-model="query"
          x-on:input.debounce.300ms="search()"
          type="search"
          name="q"
          placeholder="Search products..."
          autocomplete="off"
          class="w-full pl-10 pr-4 py-3 bg-gray-100 border-0 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-gray-900 focus:bg-white transition"
        >
        <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
          {% render 'icon-search' %}
        </div>
        <button
          x-show="query.length > 0"
          x-on:click.prevent="clearSearch()"
          type="button"
          class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
        >
          {% render 'icon-close' %}
        </button>
      </div>
    </form>

    <!-- Results -->
    <div class="max-h-96 overflow-y-auto">
      <!-- Loading State -->
      <div x-show="loading" class="p-8 text-center">
        <div class="inline-block w-6 h-6 border-2 border-gray-300 border-t-gray-900 rounded-full animate-spin"></div>
      </div>

      <!-- Results List -->
      <div x-show="!loading && results.length > 0">
        <div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider bg-gray-50">Products</div>

        <template x-for="product in results" :key="product.id">
          <a
            :href="product.url"
            class="flex items-center gap-4 p-4 hover:bg-gray-50 transition"
          >
            <div class="w-16 h-16 bg-gray-100 rounded-md overflow-hidden flex-shrink-0">
              <img
                x-show="product.image"
                :src="product.image"
                :alt="product.title"
                class="w-full h-full object-cover"
                width="64"
                height="64"
              >
              <div
                x-show="!product.image"
                class="w-full h-full flex items-center justify-center text-gray-300"
              >
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1"
                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
              </div>
            </div>

            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium text-gray-900 truncate" x-text="product.title"></p>
              <p class="text-sm text-gray-500" x-text="product.price"></p>
            </div>
          </a>
        </template>

        <!-- View All Results -->
        <a
          :href="'/search?q=' + encodeURIComponent(query)"
          class="block p-4 text-center text-sm font-medium text-gray-900 bg-gray-50 hover:bg-gray-100 transition"
        >
          View all results
        </a>
      </div>

      <!-- No Results -->
      <div x-show="!loading && query.length >= 2 && results.length === 0" class="p-8 text-center">
        <p class="text-gray-500">No products found</p>
      </div>

      <!-- Initial State -->
      <div x-show="!loading && query.length < 2 && results.length === 0" class="p-8 text-center">
        <p class="text-gray-400 text-sm">Type to search products...</p>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('alpine:init', () => {
    Alpine.data('predictiveSearch', () => ({
      isOpen: false,
      query: '',
      results: [],
      loading: false,

      toggle() {
        this.isOpen = !this.isOpen;
        if (this.isOpen) {
          this.$nextTick(() => this.$refs.searchInput.focus());
        }
      },

      close() {
        this.isOpen = false;
      },

      clearSearch() {
        this.query = '';
        this.results = [];
        this.$refs.searchInput.focus();
      },

      async search() {
        if (this.query.length < 2) {
          this.results = [];
          return;
        }

        this.loading = true;

        try {
          const response = await fetch(
            `/search/suggest.json?q=${encodeURIComponent(this.query)}&resources[type]=product&resources[limit]=5`
          );
          const data = await response.json();

          this.results = data.resources.results.products.map((product) => ({
            id: product.id,
            title: product.title,
            url: product.url,
            price: product.price,
            image: product.image ? product.image + '&width=128' : null,
          }));
        } catch (error) {
          console.error('Search error:', error);
          this.results = [];
        } finally {
          this.loading = false;
        }
      },
    }));
  });
</script>
