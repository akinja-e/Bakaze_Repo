{% assign main_menu = linklists[section.settings.menu].links %}

<style>
  .header-transparent:not(.header-scrolled) {
    background: transparent;
    box-shadow: none;
  }

  .header-transparent:not(.header-scrolled) .header-inner {
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .header-scrolled {
    background: white;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
  }

  .header-scrolled .header-inner {
    padding-top: 0.75rem;
    padding-bottom: 0.75rem;
  }

  .header-scrolled .header-logo {
    font-size: 1.125rem;
  }

  .dropdown-enter {
    transition: opacity 150ms ease, transform 150ms ease;
  }

  .dropdown-enter-start {
    opacity: 0;
    transform: translateY(-8px);
  }

  .dropdown-enter-end {
    opacity: 1;
    transform: translateY(0);
  }

  /* Cart badge */
  .cart-count {
    position: absolute;
    top: -6px;
    right: -6px;
    min-width: 18px;
    height: 18px;
    padding: 0 4px;
    font-size: 10px;
    font-weight: 600;
    line-height: 18px;
    text-align: center;
    background-color: #111827;
    color: white;
    border-radius: 9999px;
  }

  /* Mobile menu backdrop */
  .mobile-menu-backdrop {
    background: rgba(0, 0, 0, 0.5);
  }

  /* Mobile accordion */
  .accordion-content {
    overflow: hidden;
    transition: max-height 0.3s ease;
  }
</style>

<header
  x-data="stickyHeader()"
  x-on:scroll.window="handleScroll()"
  :class="{ 'header-scrolled': scrolled, 'header-transparent': {{ section.settings.transparent_header }} }"
  class="fixed top-0 left-0 right-0 z-50 transition-all duration-300"
  x-cloak
>
  <div class="header-inner mx-auto px-4 sm:px-6 lg:px-8 py-4 transition-all duration-300">
    <div class="flex items-center justify-between">
      <!-- Logo -->
      <div class="flex-shrink-0">
        <a href="{{ routes.root_url }}" class="header-logo text-xl font-bold text-gray-900 transition-all duration-300">
          {{ section.settings.logo_text | default: shop.name }}
        </a>
      </div>

      <!-- Desktop Navigation -->
      <nav class="hidden lg:flex items-center space-x-8">
        {% for link in main_menu %}
          {% if link.links != blank %}
            <!-- Dropdown Menu Item -->
            <div
              x-data="dropdown()"
              x-on:mouseenter="openWithDelay()"
              x-on:mouseleave="closeWithDelay()"
              class="relative"
            >
              <button
                type="button"
                class="flex items-center gap-1 text-sm font-medium text-gray-700 hover:text-gray-900 transition"
                :class="{ 'text-gray-900': isOpen }"
              >
                {{ link.title }}
                <span class="transition-transform duration-200" :class="{ 'rotate-180': isOpen }">
                  {% render 'icon-chevron-down', class: 'w-4 h-4' %}
                </span>
              </button>

              <!-- Dropdown Panel -->
              <div
                x-show="isOpen"
                x-transition:enter="transition ease-out duration-150"
                x-transition:enter-start="opacity-0 -translate-y-2"
                x-transition:enter-end="opacity-100 translate-y-0"
                x-transition:leave="transition ease-in duration-100"
                x-transition:leave-start="opacity-100 translate-y-0"
                x-transition:leave-end="opacity-0 -translate-y-2"
                x-cloak
                x-on:mouseenter="cancelClose()"
                x-on:mouseleave="closeWithDelay()"
                class="absolute left-0 top-full pt-2"
              >
                <div class="w-56 bg-white rounded-lg shadow-lg ring-1 ring-black ring-opacity-5 overflow-hidden">
                  <div class="py-2">
                    {% for sublink in link.links %}
                      <a
                        href="{{ sublink.url }}"
                        class="block px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 hover:text-gray-900 transition"
                      >
                        {{ sublink.title }}
                      </a>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
          {% else %}
            <!-- Simple Menu Item -->
            <a
              href="{{ link.url }}"
              class="text-sm font-medium text-gray-700 hover:text-gray-900 transition {% if link.active %}text-gray-900{% endif %}"
            >
              {{ link.title }}
            </a>
          {% endif %}
        {% endfor %}
      </nav>

      <!-- Desktop Actions -->
      <div class="hidden lg:flex items-center space-x-4">
        <!-- Search -->
        {% render 'predictive-search' %}

        <!-- Cart -->
        <a href="{{ routes.cart_url }}" class="relative p-2 text-gray-700 hover:text-gray-900 transition">
          {% render 'icon-shopping-bag' %}
          {% if cart.item_count > 0 %}
            <span class="cart-count">{{ cart.item_count }}</span>
          {% endif %}
        </a>

        <!-- Account -->
        {% if shop.customer_accounts_enabled %}
          {% if customer %}
            <a href="{{ routes.account_url }}" class="text-sm font-medium text-gray-700 hover:text-gray-900 transition">
              Account
            </a>
            <a
              href="{{ routes.account_logout_url }}"
              class="text-sm font-medium text-gray-700 hover:text-gray-900 transition"
            >
              Logout
            </a>
          {% else %}
            <a
              href="{{ routes.account_login_url }}"
              class="text-sm font-medium text-gray-700 hover:text-gray-900 transition"
            >
              Login
            </a>
          {% endif %}
        {% endif %}
      </div>

      <!-- Mobile Actions -->
      <div class="flex lg:hidden items-center space-x-2">
        <!-- Cart -->
        <a href="{{ routes.cart_url }}" class="relative p-2 text-gray-700">
          {% render 'icon-shopping-bag' %}
          {% if cart.item_count > 0 %}
            <span class="cart-count">{{ cart.item_count }}</span>
          {% endif %}
        </a>

        <!-- Menu Toggle -->
        <button
          x-on:click="mobileMenuOpen = true"
          type="button"
          class="p-2 text-gray-700"
          aria-label="Open menu"
        >
          {% render 'icon-hamburger' %}
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile Menu -->
  <div
    x-show="mobileMenuOpen"
    x-cloak
    class="fixed inset-0 z-50 lg:hidden"
  >
    <!-- Backdrop -->
    <div
      x-show="mobileMenuOpen"
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      x-on:click="mobileMenuOpen = false"
      class="fixed inset-0 mobile-menu-backdrop"
    ></div>

    <!-- Menu Panel -->
    <div
      x-show="mobileMenuOpen"
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="-translate-x-full"
      x-transition:enter-end="translate-x-0"
      x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="translate-x-0"
      x-transition:leave-end="-translate-x-full"
      class="fixed top-0 left-0 bottom-0 w-full max-w-sm bg-white shadow-xl flex flex-col"
    >
      <!-- Menu Header -->
      <div class="flex items-center justify-between p-4 border-b border-gray-200">
        <span class="text-lg font-bold text-gray-900">{{ shop.name }}</span>
        <button
          x-on:click="mobileMenuOpen = false"
          type="button"
          class="p-2 text-gray-500 hover:text-gray-700"
          aria-label="Close menu"
        >
          {% render 'icon-close' %}
        </button>
      </div>

      <!-- Mobile Search -->
      <div class="p-4 border-b border-gray-200">
        <form action="{{ routes.search_url }}" method="get">
          <div class="relative">
            <input
              type="search"
              name="q"
              placeholder="Search products..."
              class="w-full pl-10 pr-4 py-3 bg-gray-100 border-0 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-gray-900"
            >
            <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
              {% render 'icon-search' %}
            </div>
          </div>
        </form>
      </div>

      <!-- Menu Links -->
      <nav class="flex-1 overflow-y-auto py-4">
        {% for link in main_menu %}
          {% if link.links != blank %}
            <!-- Accordion Item -->
            <div x-data="{ expanded: false }" class="border-b border-gray-100">
              <button
                x-on:click="expanded = !expanded"
                type="button"
                class="flex items-center justify-between w-full px-4 py-3 text-left"
              >
                <span class="text-base font-medium text-gray-900">{{ link.title }}</span>
                <span class="transition-transform duration-200" :class="{ 'rotate-180': expanded }">
                  {% render 'icon-chevron-down', class: 'w-5 h-5 text-gray-400' %}
                </span>
              </button>

              <div
                x-show="expanded"
                x-collapse
                class="bg-gray-50"
              >
                {% for sublink in link.links %}
                  <a
                    href="{{ sublink.url }}"
                    class="block px-8 py-2.5 text-sm text-gray-600 hover:text-gray-900"
                  >
                    {{ sublink.title }}
                  </a>
                {% endfor %}
              </div>
            </div>
          {% else %}
            <!-- Simple Link -->
            <a
              href="{{ link.url }}"
              class="block px-4 py-3 text-base font-medium text-gray-900 border-b border-gray-100"
            >
              {{ link.title }}
            </a>
          {% endif %}
        {% endfor %}
      </nav>

      <!-- Menu Footer -->
      <div class="p-4 border-t border-gray-200 space-y-2">
        {% if shop.customer_accounts_enabled %}
          {% if customer %}
            <a
              href="{{ routes.account_url }}"
              class="block w-full py-2.5 text-center text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition"
            >
              My Account
            </a>
            <a
              href="{{ routes.account_logout_url }}"
              class="block w-full py-2.5 text-center text-sm font-medium text-gray-700 hover:text-gray-900 transition"
            >
              Logout
            </a>
          {% else %}
            <a
              href="{{ routes.account_login_url }}"
              class="block w-full py-2.5 text-center text-sm font-medium text-white bg-gray-900 rounded-lg hover:bg-gray-800 transition"
            >
              Login
            </a>
            <a
              href="{{ routes.account_register_url }}"
              class="block w-full py-2.5 text-center text-sm font-medium text-gray-700 hover:text-gray-900 transition"
            >
              Create Account
            </a>
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
</header>

<!-- Spacer to prevent content from going under fixed header -->
<div class="h-20"></div>

<script>
  document.addEventListener('alpine:init', () => {
    // Sticky Header Component
    Alpine.data('stickyHeader', () => ({
      scrolled: false,
      mobileMenuOpen: false,

      handleScroll() {
        this.scrolled = window.scrollY > 50;
      },

      init() {
        this.handleScroll();
      },
    }));

    // Dropdown Component with Hover Delay
    Alpine.data('dropdown', () => ({
      isOpen: false,
      closeTimeout: null,
      openTimeout: null,
      hoverDelay: 150,

      openWithDelay() {
        this.cancelClose();
        this.isOpen = true;
      },

      closeWithDelay() {
        this.closeTimeout = setTimeout(() => {
          this.isOpen = false;
        }, this.hoverDelay);
      },

      cancelClose() {
        if (this.closeTimeout) {
          clearTimeout(this.closeTimeout);
          this.closeTimeout = null;
        }
      },

      toggle() {
        this.isOpen = !this.isOpen;
      },
    }));
  });
</script>

{% schema %}
{
  "name": "Header",
  "settings": [
    {
      "type": "header",
      "content": "Logo"
    },
    {
      "type": "text",
      "id": "logo_text",
      "label": "Logo Text",
      "default": "StoreName"
    },
    {
      "type": "header",
      "content": "Navigation"
    },
    {
      "type": "link_list",
      "id": "menu",
      "label": "Menu",
      "default": "main-menu"
    },
    {
      "type": "header",
      "content": "Header Style"
    },
    {
      "type": "checkbox",
      "id": "transparent_header",
      "label": "Transparent Header",
      "default": true,
      "info": "Header will be transparent until user scrolls"
    }
  ]
}
{% endschema %}
